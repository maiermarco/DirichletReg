#TO DO:
#anova(resC1)
#residuals(resC1)
#update(resC1)



cat("================================================================================\n")
cat("=== Arctic Lake Data Tests =====================================================\n")
cat("================================================================================\n")

context("  AL: Original Data\n   ")

test_that("Arctic Lake - Original Data Structure", {
  expect_true(exists("ArcticLake"))
  expect_identical(dim(ArcticLake), c(39L, 4L))
  expect_identical(names(ArcticLake), c("sand", "silt", "clay", "depth"))
  expect_true(all(unlist(lapply(ArcticLake, function(colElement){ class(colElement) == "numeric" }))))
})

context("  AL: Transformation\n   ")

AL <- ArcticLake[, 4, drop=FALSE]

test_that("Arctic Lake - Data Transformation", {
  expect_identical(dim(AL), c(39L, 1L))
  expect_identical(class(AL), "data.frame")
  expect_warning(AL$Y <<- DR_data(ArcticLake[, 1:3]), ".*normalization forced.*")
  expect_equal(unname(rowSums(AL$Y)), rep(1.0, 39L))
})

cat("\n  --- Checks: Common Model -----------------------------------------------------")

#
#
#
#
#

context("  AL: Common - Null Model ( Y ~ 1 )\n   ")

resC1 <- DirichReg(Y ~ 1, AL)

resC1_mathematica <- list(
  MLE     =  39.52929411370061365530,
  DEV     = -79.05858822740122731060,
  COEFS   = c(0.02097861493616783052574, 0.8408687713317540853724, 0.2613372419951986613011),
  SE      = c(0.1662656209409404954810, 0.1726406312466813760947, 0.1682475856662426178722),
  Z       = c(0.1261753020103878320402, 4.870630773645980149831, 1.553289700772411471728),
  P       = c(0.8995931612401563064894, 1.112425458312201743960e-6, 0.1203539396684395661496),
  GRAD    = c(0e-64,0e-62,0e-63),
  HESSIAN = matrix(c(-55.10500066979587876697, 22.20582474400168179970, 12.43883086502252973858, 22.20582474400168179970, -62.21464112109048121996, 28.23926138550186271570, 12.43883086502252973858, 28.23926138550186271570, -58.89205189102017582447), 3L),
  VCOV    = matrix(c(0.02764425670687651061389, 0.01599938109376821138710, 0.01351070157568414676500, 0.01599938109376821138710, 0.02980478755725261791073, 0.01767095470989548347560, 0.01351070157568414676500, 0.01767095470989548347560, 0.02830725008251964840603),3),
  NOBS    = 39L,
  NPAR    = 3L,
  AIC     = -73.05858822740122731060,
  BIC     = -68.06790328901228802825,
  CONFINT = t(matrix(c(
            -0.4072932436562604559727, -0.30489601397526418451550, +0.02097861493616783052574, +0.3468532438475998455670, +0.4492504735285961170242,
            +0.3961759743833722014562, +0.50249935181999826457490, +0.84086877133175408537240, +1.1792381908435099061700, +1.2855615682801359692890,
            -0.1720398194152630795265, -0.06842196639645433559012, +0.26133724199519866130110, +0.5910964503868516581924, +0.6947143034056604021288), 5)),
  PREDICT = list(
    ALPHA = c(1.021200212972279022750, 2.318380244412313173929, 1.298665556155223040582),
    PHI   = 4.638246013539815237261,
    MU    = c(0.2201694800127515751630, 0.4998398613709953725498, 0.2799906586162530522872)
  )
)

test_that("Model Estimation", {
  expect_equal(resC1_mathematica$MLE, resC1$logLik)
  expect_equal(resC1_mathematica$DEV, -2.0*resC1$logLik)
  expect_equal(resC1_mathematica$COEFS, unname(resC1$coefficients), check.attributes = FALSE)
  expect_equal(resC1_mathematica$SE, unname(resC1$se), check.attributes = FALSE)
  expect_equal(resC1_mathematica$Z, unname(resC1$coefficients / resC1$se), check.attributes = FALSE)
  expect_equal(resC1_mathematica$P, 2*pnorm(-abs(unname(resC1$coefficients / resC1$se))), check.attributes = FALSE)
  expect_equal(resC1_mathematica$HESSIAN, unname(resC1$hessian), check.attributes = FALSE)
  expect_equal(resC1_mathematica$VCOV, unname(resC1$vcov), check.attributes = FALSE)
})

test_that("Methods", {
  expect_equal(resC1_mathematica$NOBS, nobs(resC1), check.attributes = FALSE)
  expect_equal(resC1_mathematica$MLE, unclass(logLik(resC1)), check.attributes = FALSE)
  expect_equal(resC1_mathematica$NPAR, attributes(logLik(resC1))$df, check.attributes = FALSE)
  expect_equal(resC1_mathematica$AIC, AIC(resC1), check.attributes = FALSE)
  expect_equal(resC1_mathematica$BIC, BIC(resC1), check.attributes = FALSE)
  expect_equal(resC1_mathematica$COEFS, unlist(coef(resC1)), check.attributes = FALSE)
  expect_equal(resC1_mathematica$VCOV, vcov(resC1), check.attributes = FALSE)

  expect_equal(resC1_mathematica$PREDICT$ALPHA, unname(fitted(resC1, alpha=T, phi=F, mu=F))[1,], check.attributes = FALSE)
  expect_equal(resC1_mathematica$PREDICT$PHI,   unname(fitted(resC1, alpha=F, phi=T, mu=F))[1], check.attributes = FALSE)
  expect_equal(resC1_mathematica$PREDICT$MU,    unname(fitted(resC1, alpha=F, phi=F, mu=T))[1,], check.attributes = FALSE)

  expect_equal(resC1_mathematica$PREDICT$ALPHA, unname(predict(resC1, data.frame("depth"=0), alpha=T, phi=F, mu=F))[1,], check.attributes = FALSE)
  expect_equal(resC1_mathematica$PREDICT$PHI,   unname(predict(resC1, data.frame("depth"=0), alpha=F, phi=T, mu=F)), check.attributes = FALSE)
  expect_equal(resC1_mathematica$PREDICT$MU,    unname(predict(resC1, data.frame("depth"=0), alpha=F, phi=F, mu=T))[1,], check.attributes = FALSE)

  conf_ints <- confint(resC1, level = c(.99, .95))
  conf_ints <- lapply(1:3, function(listelement){ sort(unlist(lapply(c(list(conf_ints$coefficients), conf_ints$ci), `[[`, listelement))) })
  conf_ints <- unname(t(matrix(unlist(conf_ints), 5)))
  expect_equal(resC1_mathematica$CONFINT, conf_ints)
})

rm(resC1, resC1_mathematica)

#
#
#
#
#

context("  AL: Common - Linear ( Y ~ depth )\n   ")

resC2 <- DirichReg(Y ~ depth, AL)

resC2_mathematica <- list(
  MLE     =  101.3696577427714806461,
  DEV     = -202.7393154855429612921,
  COEFS   = c(0.1166247952607467041461, 0.02335114245359105191499, -0.3105959107722850426911, 0.05556745379837196237638, -1.151956420916952644781, 0.06430175077280428103938),
  SE      = c(0.4092918207555025588504, 0.007453915206170117513626, 0.3447313810827568960005, 0.006365297997865231830279, 0.2984727717191367603189, 0.005738180377685536656006),
  Z       = c(0.2849428924464496255424, 3.132735187846208347917, -0.9009795098918562771992, 8.729748994785154231601, -3.859502541159583668986, 11.20594797313430513976),
  P       = c(0.7756878940716974521505, 0.001731856160347966505908, 0.3675992142040701555883, 2.552384418874433995375e-18, 0.0001136180757194500192318, 3.812502570235694522254e-29),
  GRAD    = c(8.408878043968415530590e-31, 4.237970704341028591988e-27, 3.320117037084460494647e-30, 2.437477804529998647901e-26, 3.752395939531675936383e-30, 2.438691971351563591346e-26),
  HESSIAN = matrix(c(-166.5249197275282845595, -11173.57583958389147216, 83.21608135103832972151, 5530.709617692177770330, 65.80977008051300311778, 4759.502819690659431909, -11173.57583958389147216, -847498.5883218990211245, 5530.709617692177770330, 427139.7463992286680947, 4759.502819690659431909, 385162.2963684013634081, 83.21608135103832972151, 5530.709617692177770330, -665.3207111256914199353, -55368.01701820549548871, 570.6990485366344846082, 49333.42155383906306364, 5530.709617692177770330, 427139.7463992286680947, -55368.01701820549548871, -4.874973443680105287809e6, 49333.42155383906306364, 4.425777591954708027690e6, 65.80977008051300311778, 4759.502819690659431909, 570.6990485366344846082, 49333.42155383906306364, -651.9629935716165561842, -54723.24560471096010805, 4759.502819690659431909, 385162.2963684013634081, 49333.42155383906306364, 4.425777591954708027690e6, -54723.24560471096010805, -4.877430427072082960712e6), 6L),
  VCOV    = matrix(c(0.1675197945373544352239, -0.002799914848780817498041, 0.1131375648864946021496, -0.002041206668004976780565, 0.09097116833559484019061, -0.001786147842815775726619, -0.002799914848780817498041, 0.00005556085190077410547928, -0.001919727920707691441994, 0.00004238757411808942615796, -0.001502634793763224992832, 0.00003755953615930779920379, 0.1131375648864946021496, -0.001919727920707691441994, 0.1188397251032249590979, -0.001937139434905606626622, 0.08505399926310637473107, -0.001551213760473688054707, -0.002041206668004976780565, 0.00004238757411808942615796, -0.001937139434905606626622, 0.00004051701860162712888218, -0.001398705285204410162957, 0.00003422012030893068566176, 0.09097116833559484019061, -0.001502634793763224992832, 0.08505399926310637473107, -0.001398705285204410162957, 0.08908599545770392467786, -0.001438300219418600692718, -0.001786147842815775726619, 0.00003755953615930779920379, -0.001551213760473688054707, 0.00003422012030893068566176, -0.001438300219418600692718, 0.00003292671404685532810389),6),
  NOBS    = 39L,
  NPAR    = 6L,
  AIC     = -190.7393154855429612921,
  BIC     = -180.7579456087650827274,
  CONFINT = t(matrix(c(-0.9376410703441609773072, 0.004151129239369317091499, -1.198565104018133440844, 0.03917153268964954986818, -1.920771332622566729403, 0.04952117760691257682561, -0.6855724325868617623851, 0.008741737105682168532899, -0.9862570020352411247517, 0.04309169897169119295910, -1.736952303852305943132, 0.05305512389574618329872, 0.1166247952607467041461, 0.02335114245359105191499, -0.3105959107722850426911, 0.05556745379837196237638, -1.151956420916952644781, 0.06430175077280428103938, 0.9188220231083551706773, 0.03796054780149993529708, 0.3650651804906710393695, 0.06804320862505273179366, -0.5669605379815993464294, 0.07554837764986237878003, 1.170890660865654385599, 0.04255115566781278673848, 0.5773732824735633554619, 0.07196337490709437488458, -0.3831415092113385601586, 0.07908232393869598525314), ncol=6L, byrow=TRUE)),
  PREDICT = eval(parse("resC2_PREDICT.R"))
)

test_that("Model Estimation", {
  expect_equal(resC2_mathematica$MLE, resC2$logLik)
  expect_equal(resC2_mathematica$DEV, -2.0*resC2$logLik)
  expect_equal(resC2_mathematica$COEFS, unname(resC2$coefficients), check.attributes = FALSE)
  expect_equal(resC2_mathematica$SE, unname(resC2$se), check.attributes = FALSE)
  expect_equal(resC2_mathematica$Z, unname(resC2$coefficients / resC2$se), check.attributes = FALSE)
  expect_equal(resC2_mathematica$P, 2*pnorm(-abs(unname(resC2$coefficients / resC2$se))), check.attributes = FALSE)
  expect_equal(resC2_mathematica$HESSIAN, unname(resC2$hessian), check.attributes = FALSE)
  expect_equal(resC2_mathematica$VCOV, unname(resC2$vcov), check.attributes = FALSE)
})

test_that("Methods", {
  expect_equal(resC2_mathematica$NOBS, nobs(resC2), check.attributes = FALSE)
  expect_equal(resC2_mathematica$MLE, unclass(logLik(resC2)), check.attributes = FALSE)
  expect_equal(resC2_mathematica$NPAR, attributes(logLik(resC2))$df, check.attributes = FALSE)
  expect_equal(resC2_mathematica$AIC, AIC(resC2), check.attributes = FALSE)
  expect_equal(resC2_mathematica$BIC, BIC(resC2), check.attributes = FALSE)
  expect_equal(resC2_mathematica$COEFS, unlist(coef(resC2)), check.attributes = FALSE)
  expect_equal(resC2_mathematica$VCOV, vcov(resC2), check.attributes = FALSE)

#  expect_equal(resC2_mathematica$PREDICT$ALPHA, unname(fitted(resC2, alpha=T, phi=F, mu=F))[1,], check.attributes = FALSE)
#  expect_equal(resC2_mathematica$PREDICT$PHI,   unname(fitted(resC2, alpha=F, phi=T, mu=F))[1], check.attributes = FALSE)
#  expect_equal(resC2_mathematica$PREDICT$MU,    unname(fitted(resC2, alpha=F, phi=F, mu=T))[1,], check.attributes = FALSE)

  expect_equal(resC2_mathematica$PREDICT$ALPHA, unname(predict(resC2, data.frame("depth"=0:150), alpha=T, phi=F, mu=F)), check.attributes = FALSE)
  expect_equal(resC2_mathematica$PREDICT$PHI,   unname(predict(resC2, data.frame("depth"=0:150), alpha=F, phi=T, mu=F)), check.attributes = FALSE)
  expect_equal(resC2_mathematica$PREDICT$MU,    unname(predict(resC2, data.frame("depth"=0:150), alpha=F, phi=F, mu=T)), check.attributes = FALSE)

  # BEWARE! UGLY CODE AHEAD!
  conf_ints <- confint(resC2, level = c(.99, .95))
  conf_mat <- matrix(NA, 6, 4); rowz <- rep(1:2, 3); listz <- rep(1:3, each=2)
  for(i in 1:6){
    conf_mat[i,] <- c(conf_ints$ci[[2L]][[listz[i]]][rowz[i], 1L], conf_ints$ci[[1L]][[listz[i]]][rowz[i], ], conf_ints$ci[[2L]][[listz[i]]][rowz[i], 2L])
  }
  conf_ints <- unname(cbind(conf_mat[,1:2], unlist(conf_ints$coefficients), conf_mat[,3:4]))
  expect_equal(resC2_mathematica$CONFINT, conf_ints)
})

rm(resC2, resC2_mathematica)


#
#
#
#
#

context("  AL: Common - Linear + Quadratic ( Y ~ depth + I(depth^2) )\n   ")

resC3 <- DirichReg(Y ~ depth + I(depth^2), AL)

resC3_mathematica <- list(
  MLE     =  108.9968613881664638515,
  DEV     = -217.9937227763329277031,
  COEFS   = c(1.436196704393462554466, -0.007238250062160947809107, 0.0001324037064772408841522, -0.02597048067138775199912, 0.07174498803590554239226, -0.0002679266468138430818866, -1.793148688970374366732, 0.1107905843333105968083, -0.0004871581809562041266339),
  SE      = c(0.8026813568072803707047, 0.03294328871399902136479, 0.0002760882125752448337899, 0.7598826912172800068490, 0.03430886884588387701471, 0.0003088499287457494585540, 0.7362292969361635259097, 0.03577046011699290003525, 0.0003307616530731696619297),
  Z       = c(1.789248862221034407194, -0.2197185024543437218826, 0.4795702983558405151463, -0.03417696043291211353856, 2.091149911067760912406, -0.8674978424048945726690, -2.435584533830162827276, 3.097264725445314776537, -1.472837544588148195701),
  P       = c(0.07357474567412447073199, 0.8260903938940497313435, 0.6315329703597601337646, 0.9727360387168220501934, 0.03651462776539824282867, 0.3856692934470863964767, 0.01486775018069914495929, 0.001953153681187561309586, 0.1407948460096624492598),
  GRAD    = c(7.956026763952740715450e-27, 1.298858071533044471854e-25, 2.190462111398068688547e-23, 1.062364408234147630055e-27, 5.632862539783716208522e-26, 1.175613029787923001998e-22, -7.899285946113645445700e-27, -1.704266209346016950807e-25, 1.159228855316536930435e-22),
  HESSIAN = matrix(c(-161.2492021181938165116, -9504.287711118129089521, -686527.0822078098450759, 85.77714308215444618070, 4751.721652576602449524, 333534.7497619234220333, 59.13993393842398842328, 3877.944941895742020954, 294381.3784556272399686, -9504.287711118129089521, -686527.0822078098450759, -5.567971544034400973317e7, 4751.721652576602449524, 333534.7497619234220333, 2.640175885354799718644e7, 3877.944941895742020954, 294381.3784556272399686, 2.416052817693200946108e7, -686527.0822078098450759, -5.567971544034400973317e7, -4.834631521473129303726e9, 333534.7497619234220333, 2.640175885354799718644e7, 2.230765154455230203276e9, 294381.3784556272399686, 2.416052817693200946108e7, 2.077863668054330773807e9, 85.77714308215444618070, 4751.721652576602449524, 333534.7497619234220333, -521.4000123701478028226, -38816.47208559843950025, -3.170206542756950168645e6, 424.4774308069897757081, 33567.99433680004227200, 2.805692945240309858619e6, 4751.721652576602449524, 333534.7497619234220333, 2.640175885354799718644e7, -38816.47208559843950025, -3.170206542756950168645e6, -2.720263080289101856703e8, 33567.99433680004227200, 2.805692945240309858619e6, 2.431213819707016687843e8, 333534.7497619234220333, 2.640175885354799718644e7, 2.230765154455230203276e9, -3.170206542756950168645e6, -2.720263080289101856703e8, -2.408784936424644127405e10, 2.805692945240309858619e6, 2.431213819707016687843e8, 2.161514334420104559284e10, 59.13993393842398842328, 3877.944941895742020954, 294381.3784556272399686, 424.4774308069897757081, 33567.99433680004227200, 2.805692945240309858619e6, -499.4019398095307312395, -38070.42121750847681575, -3.135893212450536319423e6, 3877.944941895742020954, 294381.3784556272399686, 2.416052817693200946108e7, 33567.99433680004227200, 2.805692945240309858619e6, 2.431213819707016687843e8, -38070.42121750847681575, -3.135893212450536319423e6, -2.692302745809471652260e8, 294381.3784556272399686, 2.416052817693200946108e7, 2.077863668054330773807e9, 2.805692945240309858619e6, 2.431213819707016687843e8, 2.161514334420104559284e10, -3.135893212450536319423e6, -2.692302745809471652260e8, -2.373641939540093785496e10), 9L),
  VCOV    = matrix(c(0.6442973605659765419106, -0.02515004197409831539965, 0.0001955108375325154097639, 0.5333019863892166680079, -0.02213019438655139720584, 0.0001789394378221439141159, 0.4586006970775877846856, -0.02064756930631587611378, 0.0001724296896934547247602, -0.02515004197409831539965, 0.001085260271293895294871, -8.896947661578553611366e-6, -0.02180609803559262785647, 0.001007716949244641836300, -8.608979577627908341571e-6, -0.01997945277389360384557, 0.0009894844806575897902684, -8.665318779534572514325e-6, 0.0001955108375325154097639, -8.896947661578553611366e-6, 7.622470112299357957748e-8, 0.0001758236103192687411384, -8.596439082601260840989e-6, 7.668756276900027909594e-8, 0.0001687506388929059795091, -8.720160760676792050740e-6, 7.922311992732980084408e-8, 0.5333019863892166680079, -0.02180609803559262785647, 0.0001758236103192687411384, 0.5774217044116161136571, -0.02451423856297362748594, 0.0002039080489212408892514, 0.4741963419330598072175, -0.02224590800978342915183, 0.0001923357405766524324904, -0.02213019438655139720584, 0.001007716949244641836300, -8.596439082601260840989e-6, -0.02451423856297362748594, 0.001177098481484061275171, -0.00001038367982488882054905, -0.02217735644566320645061, 0.001145088930701724201161, -0.00001035636832714991718655, 0.0001789394378221439141159, -8.608979577627908341571e-6, 7.668756276900027909594e-8, 0.0002039080489212408892514, -0.00001038367982488882054905, 9.538827848625451771700e-8, 0.0001952281713285856948562, -0.00001047665575411584696332, 9.781945257726745428753e-8, 0.4586006970775877846856, -0.01997945277389360384557, 0.0001687506388929059795091, 0.4741963419330598072175, -0.02217735644566320645061, 0.0001952281713285856948562, 0.5420335776671176441191, -0.02500798206998023624649, 0.0002188460383482756292860, -0.02064756930631587611378, 0.0009894844806575897902684, -8.720160760676792050740e-6, -0.02224590800978342915183, 0.001145088930701724201161, -0.00001047665575411584696332, -0.02500798206998023624649, 0.001279525816981379715677, -0.00001166266143201109833890, 0.0001724296896934547247602, -8.665318779534572514325e-6, 7.922311992732980084408e-8, 0.0001923357405766524324904, -0.00001035636832714991718655, 9.781945257726745428753e-8, 0.0002188460383482756292860, -0.00001166266143201109833890, 1.094032711436958456640e-7), 9L),
  NOBS    = 39L,
  NPAR    = 9L,
  AIC     = -199.9937227763329277031,
  BIC     = -185.0216679611661098560,
  CONFINT = t(matrix(c(-0.6313734558831211557069, -0.09209453848695140959810, -0.0005787524018385128811029, -1.983298583968458521060, -0.01662880170893810317530, -0.001063471343676134534843, -3.689549686149749318513, 0.01865198496253304387573, -0.001339143739432349867997, -0.1370298460105516676259, -0.07180590947390386889744, -0.0004087192467262774886377, -1.515313187932627549760, 0.004500840747664846860864, -0.0008732613837832740259004, -3.236131595328500174777, 0.04068177079357809786260, -0.001135439108446548812429, 1.436196704393462554466, -0.007238250062160947809107, 0.0001324037064772408841522, -0.02597048067138775199912, 0.07174498803590554239226, -0.0002679266468138430818866, -1.793148688970374366732, 0.1107905843333105968083, -0.0004871581809562041266339, 3.009423254797476776558, 0.05732940934958197327923, 0.0006735266596807592569421, 1.463372226589852045762, 0.1389891353241462379237, 0.0003374080901555878621273, -0.3501657826122485586872, 0.1808993978730430957539, 0.0001611227465341405591611, 3.503766864670046264639, 0.07761803836262951397989, 0.0008435598147929946494073, 1.931357622625683017062, 0.1601187777807491879598, 0.0005276180500484483710698, 0.1032523082090005850486, 0.2029291837040881497408, 0.0003648273775199416147297), ncol = 9L, byrow=TRUE)),
  PREDICT = eval(parse("resC3_PREDICT.R"))
)

test_that("Model Estimation", {
  expect_equal(resC3_mathematica$MLE, resC3$logLik)
  expect_equal(resC3_mathematica$DEV, -2.0*resC3$logLik)
  expect_equal(resC3_mathematica$COEFS, unname(resC3$coefficients), check.attributes = FALSE)
  expect_equal(resC3_mathematica$SE, unname(resC3$se), check.attributes = FALSE)
  expect_equal(resC3_mathematica$Z, unname(resC3$coefficients / resC3$se), check.attributes = FALSE)
  expect_equal(resC3_mathematica$P, 2*pnorm(-abs(unname(resC3$coefficients / resC3$se))), check.attributes = FALSE)
  expect_equal(resC3_mathematica$HESSIAN, unname(resC3$hessian), check.attributes = FALSE)
  expect_equal(resC3_mathematica$VCOV, unname(resC3$vcov), check.attributes = FALSE)
})

test_that("Methods", {
  expect_equal(resC3_mathematica$NOBS, nobs(resC3), check.attributes = FALSE)
  expect_equal(resC3_mathematica$MLE, unclass(logLik(resC3)), check.attributes = FALSE)
  expect_equal(resC3_mathematica$NPAR, attributes(logLik(resC3))$df, check.attributes = FALSE)
  expect_equal(resC3_mathematica$AIC, AIC(resC3), check.attributes = FALSE)
  expect_equal(resC3_mathematica$BIC, BIC(resC3), check.attributes = FALSE)
  expect_equal(resC3_mathematica$COEFS, unlist(coef(resC3)), check.attributes = FALSE)
  expect_equal(resC3_mathematica$VCOV, vcov(resC3), check.attributes = FALSE)

#  expect_equal(resC3_mathematica$PREDICT$ALPHA, unname(fitted(resC3, alpha=T, phi=F, mu=F))[1,], check.attributes = FALSE)
#  expect_equal(resC3_mathematica$PREDICT$PHI,   unname(fitted(resC3, alpha=F, phi=T, mu=F))[1], check.attributes = FALSE)
#  expect_equal(resC3_mathematica$PREDICT$MU,    unname(fitted(resC3, alpha=F, phi=F, mu=T))[1,], check.attributes = FALSE)

  expect_equal(resC3_mathematica$PREDICT$ALPHA, unname(predict(resC3, data.frame("depth"=0:150), alpha=T, phi=F, mu=F)), check.attributes = FALSE)
  expect_equal(resC3_mathematica$PREDICT$PHI,   unname(predict(resC3, data.frame("depth"=0:150), alpha=F, phi=T, mu=F)), check.attributes = FALSE)
  expect_equal(resC3_mathematica$PREDICT$MU,    unname(predict(resC3, data.frame("depth"=0:150), alpha=F, phi=F, mu=T)), check.attributes = FALSE)

  # BEWARE! UGLY CODE AHEAD!
  conf_ints <- confint(resC3, level = c(.99, .95))
  conf_mat <- matrix(NA, 9L, 4L); rowz <- rep(1:3, 3L); listz <- rep(1:3, each=3L)
  for(i in 1:9){
    conf_mat[i,] <- c(conf_ints$ci[[2L]][[listz[i]]][rowz[i], 1L], conf_ints$ci[[1L]][[listz[i]]][rowz[i], ], conf_ints$ci[[2L]][[listz[i]]][rowz[i], 2L])
  }
  conf_ints <- unname(cbind(conf_mat[,1:2], unlist(conf_ints$coefficients), conf_mat[,3:4]))
  expect_equal(resC3_mathematica$CONFINT, conf_ints)
})

rm(resC3, resC3_mathematica)

#
#
#
#
#

context("  AL: Common - Custom Model ( Y ~ depth | depth + I(depth^2) | 1 )\n   ")

resC4 <- DirichReg(Y ~ depth | depth + I(depth^2) | 1, AL)

resC4_mathematica <- list(
  MLE     =  62.40786352582997721245,
  DEV     = -124.8157270516599544249,
  COEFS   = c(2.660475015292720218816, -0.04335151645973448960943, 1.653666311876421085546, 0.004011771278714186721494, -0.0001239432460931779649515, 0.8012769721783982814912),
  SE      = c(0.3521952698829286257671, 0.006866513517558204149459, 0.4156964501831856773173, 0.01693782314584319870591, 0.0001611454228303347992760, 0.1728883483815808148560),
  Z       = c(7.553977133699367123193, -6.313468450747431234212, 3.978062144018061923030, 0.2368528260196610244571, -0.7691391037750672284258, 4.634649932625331023625),
  P       = c(4.221643283355742355693e-14, 2.728499701484910145133e-10, 0.00006947921484251466409743, 0.8127709680722153713207, 0.4418107365299819374883, 3.575420143321227101975e-6),
  GRAD    = c(1.270149660893027670588e-30, 7.649340210610811816542e-28, 8.986144577797992665254e-31, 1.229741151485876378800e-27, 6.450846552064034970743e-24, 4.239608643434795395134e-31),
  HESSIAN = matrix(c(-95.48734182365088035778, -3365.213091828538611183, 52.98749680698261087288, 1518.269393455107944934, 60829.88240327564319440, 23.43386581481343962445, -3365.213091828538611183, -152987.2725608418151834, 1518.269393455107944934, 60829.88240327564319440, 3.181198894881716121430e6, 729.2787184927637607820, 52.98749680698261087288, 1518.269393455107944934, -108.6779333923637403258, -4345.387702158791323750, -245948.1698068472770785, 44.39172671227386203193, 1518.269393455107944934, 60829.88240327564319440, -4345.387702158791323750, -245948.1698068472770785, -1.690412589512151238000e7, 2309.183236050966124802, 60829.88240327564319440, 3.181198894881716121430e6, -245948.1698068472770785, -1.690412589512151238000e7, -1.290169312904616356712e9, 152190.9449748112661411, 23.43386581481343962445, 729.2787184927637607820, 44.39172671227386203193, 2309.183236050966124802, 152190.9449748112661411, -84.79175561711509211436), 6L),
  VCOV    = matrix(c(0.1240415081279089314992, -0.002148932346109772670754, 0.09638351993573533772926, -0.002011057215013163881019, 0.00001253471989794129464226, 0.03398919557251004538473, -0.002148932346109772670754, 0.00004714900788680954196432, -0.001618773552698941207481, 0.00004302336719702623355885, -2.843621629413609832579e-7, -0.0003745845940627856496269, 0.09638351993573533772926, -0.001618773552698941207481, 0.1728035386949017715368, -0.005984000956250128522440, 0.00004942817176479685074516, 0.02893576497229417228242, -0.002011057215013163881019, 0.00004302336719702623355885, -0.005984000956250128522440, 0.0002868898529198615921393, -2.634523619150732818753e-6, -0.0002342250609210229472889, 0.00001253471989794129464226, -2.843621629413609832579e-7, 0.00004942817176479685074516, -2.634523619150732818753e-6, 2.596784729916738795070e-8, 1.757635576963169870216e-6, 0.03398919557251004538473, -0.0003745845940627856496269, 0.02893576497229417228242, -0.0002342250609210229472889, 1.757635576963169870216e-6, 0.02989038100611085756351), 6L),
  NOBS    = 39L,
  NPAR    = 6L,
  AIC     = -112.8157270516599544249,
  BIC     = -102.8343571748820758602,
  CONFINT = t(matrix(c(1.753280118556959033456, -0.06103848319147555136072, 0.5829032141133156021804, -0.03961716991867755116252, -0.0005390263483523323834471, 0.3559460981749512471315, 1.970184970796815668638, -0.05680963565350601107453, 0.8389162410162283270053, -0.02918575206364740518392, -0.0004397824711141127823293, 0.4624220360038861105717, 2.660475015292720218816, -0.04335151645973448960943, 1.653666311876421085546, 0.004011771278714186721494, -0.0001239432460931779649515, 0.8012769721783982814912, 3.350765059788624768994, -0.02989339726596296814432, 2.468416382736613844086, 0.03720929462107577862691, 0.0001918959789277568524264, 1.140131908352910452411, 3.567669912028481404176, -0.02566454972799342785814, 2.724429409639526568911, 0.04764071247610592460550, 0.0002911398561659764535442, 1.246607846181845315851), ncol = 6L, byrow=TRUE)),
  PREDICT = eval(parse("resC4_PREDICT.R"))
)

test_that("Model Estimation", {
  expect_equal(resC4_mathematica$MLE, resC4$logLik)
  expect_equal(resC4_mathematica$DEV, -2.0*resC4$logLik)
  expect_equal(resC4_mathematica$COEFS, unname(resC4$coefficients), check.attributes = FALSE)
  expect_equal(resC4_mathematica$SE, unname(resC4$se), check.attributes = FALSE)
  expect_equal(resC4_mathematica$Z, unname(resC4$coefficients / resC4$se), check.attributes = FALSE)
  expect_equal(resC4_mathematica$P, 2*pnorm(-abs(unname(resC4$coefficients / resC4$se))), check.attributes = FALSE)
  expect_equal(resC4_mathematica$HESSIAN, unname(resC4$hessian), check.attributes = FALSE)
  expect_equal(resC4_mathematica$VCOV, unname(resC4$vcov), check.attributes = FALSE)
})

test_that("Methods", {
  expect_equal(resC4_mathematica$NOBS, nobs(resC4), check.attributes = FALSE)
  expect_equal(resC4_mathematica$MLE, unclass(logLik(resC4)), check.attributes = FALSE)
  expect_equal(resC4_mathematica$NPAR, attributes(logLik(resC4))$df, check.attributes = FALSE)
  expect_equal(resC4_mathematica$AIC, AIC(resC4), check.attributes = FALSE)
  expect_equal(resC4_mathematica$BIC, BIC(resC4), check.attributes = FALSE)
  expect_equal(resC4_mathematica$COEFS, unlist(coef(resC4)), check.attributes = FALSE)
  expect_equal(resC4_mathematica$VCOV, vcov(resC4), check.attributes = FALSE)

#  expect_equal(resC4_mathematica$PREDICT$ALPHA, unname(fitted(resC4, alpha=T, phi=F, mu=F))[1,], check.attributes = FALSE)
#  expect_equal(resC4_mathematica$PREDICT$PHI,   unname(fitted(resC4, alpha=F, phi=T, mu=F))[1], check.attributes = FALSE)
#  expect_equal(resC4_mathematica$PREDICT$MU,    unname(fitted(resC4, alpha=F, phi=F, mu=T))[1,], check.attributes = FALSE)

  expect_equal(resC4_mathematica$PREDICT$ALPHA, unname(predict(resC4, data.frame("depth"=0:150), alpha=T, phi=F, mu=F)), check.attributes = FALSE)
  expect_equal(resC4_mathematica$PREDICT$PHI,   unname(predict(resC4, data.frame("depth"=0:150), alpha=F, phi=T, mu=F)), check.attributes = FALSE)
  expect_equal(resC4_mathematica$PREDICT$MU,    unname(predict(resC4, data.frame("depth"=0:150), alpha=F, phi=F, mu=T)), check.attributes = FALSE)

  # BEWARE! UGLY CODE AHEAD!
  conf_ints <- confint(resC4, level = c(.99, .95))
  conf_mat <- matrix(NA, 6L, 4L); rowz <- c(1,2,1,2,3,1); listz <- rep(1:3, c(2, 3, 1))
  for(i in 1:6){
    conf_mat[i,] <- c(conf_ints$ci[[2L]][[listz[i]]][rowz[i], 1L], conf_ints$ci[[1L]][[listz[i]]][rowz[i], ], conf_ints$ci[[2L]][[listz[i]]][rowz[i], 2L])
  }
  conf_ints <- unname(cbind(conf_mat[,1:2], unlist(conf_ints$coefficients), conf_mat[,3:4]))
  expect_equal(resC4_mathematica$CONFINT, conf_ints)
})

rm(resC4, resC4_mathematica)

